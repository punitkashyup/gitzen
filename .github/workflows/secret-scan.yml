name: Secret Scan

on:
  # Trigger on pull requests
  pull_request:
    branches: [ main, develop ]
  
  # Trigger on pushes to main
  push:
    branches: [ main ]
  
  # Scheduled scans (weekly on Mondays at 9 AM UTC)
  schedule:
    - cron: '0 9 * * 1'
  
  # Allow manual triggers
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write
  statuses: write

jobs:
  scan-secrets:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning
      
      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Optional for enterprise features
      
      - name: Upload Gitleaks Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: results.json
          retention-days: 30
      
      - name: Extract Metadata (Privacy-Safe)
        if: always()
        id: extract-metadata
        env:
          GITLEAKS_RESULTS: results.json
          METADATA_OUTPUT: metadata.json
          REPO_NAME: ${{ github.repository }}
          REPO_OWNER: ${{ github.repository_owner }}
          BRANCH: ${{ github.ref_name }}
          COMMIT_HASH: ${{ github.sha }}
          TRIGGER_TYPE: ${{ github.event_name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITLEAKS_VERSION: ${{ steps.setup-gitleaks.outputs.version }}
          ACTION_VERSION: "1.0.0"
        run: |
          # Install jq for JSON processing
          sudo apt-get update -qq && sudo apt-get install -y jq > /dev/null 2>&1
          
          # Run privacy-safe metadata extraction
          bash scripts/extract-metadata.sh
          
          # Count findings for output
          FINDINGS_COUNT=$(jq '.summary.total_findings' metadata.json)
          echo "findings_count=$FINDINGS_COUNT" >> $GITHUB_OUTPUT
          
          echo "✅ Extracted privacy-safe metadata for $FINDINGS_COUNT findings"
      
      - name: Send Report to Dashboard
        if: always()
        env:
          DASHBOARD_API_URL: ${{ secrets.DASHBOARD_API_URL }}
          DASHBOARD_API_KEY: ${{ secrets.DASHBOARD_API_KEY }}
        run: |
          # Prepare scan context
          SCAN_DATA=$(jq -n \
            --arg repo_name "${{ github.repository }}" \
            --arg repo_owner "${{ github.repository_owner }}" \
            --arg branch "${{ github.ref_name }}" \
            --arg commit_hash "${{ github.sha }}" \
            --arg trigger_type "${{ github.event_name }}" \
            --arg pr_number "${{ github.event.pull_request.number }}" \
            --argjson findings "$(cat metadata.json)" \
            '{
              repo_name: $repo_name,
              repo_owner: $repo_owner,
              branch: $branch,
              commit_hash: $commit_hash,
              trigger_type: $trigger_type,
              pr_number: ($pr_number | tonumber // null),
              scan_date: (now | todate),
              findings: $findings
            }')
          
          # Send to dashboard API
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${DASHBOARD_API_URL}/api/v1/scans" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${DASHBOARD_API_KEY}" \
            -H "User-Agent: SecretScan-Action/1.0" \
            -d "$SCAN_DATA")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Report sent successfully"
            REPORT_URL=$(echo "$BODY" | jq -r '.reportUrl')
            echo "report_url=$REPORT_URL" >> $GITHUB_OUTPUT
            echo "📊 View detailed report: $REPORT_URL"
          else
            echo "⚠️ Failed to send report (HTTP $HTTP_CODE)"
            echo "$BODY"
          fi
      
      - name: Update GitHub Status
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const findingsCount = '${{ steps.extract-metadata.outputs.findings_count }}';
            const reportUrl = '${{ steps.send-report.outputs.report_url }}';
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: findingsCount > 0 ? 'failure' : 'success',
              description: findingsCount > 0 
                ? `Found ${findingsCount} potential secrets` 
                : 'No secrets detected',
              context: 'Secret Scan',
              target_url: reportUrl || `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            });
      
      - name: Setup Node.js for PR Comments
        if: always() && github.event_name == 'pull_request'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Download Previous Findings
        if: always() && github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: previous-findings
          path: .
        continue-on-error: true
      
      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          FINDINGS_FILE: gitleaks-reports/results.json
          PREVIOUS_FINDINGS_FILE: previous-findings.json
        run: |
          node scripts/post-pr-comment.js
      
      - name: Save Current Findings
        if: always() && github.event_name == 'pull_request'
        run: |
          if [ -f gitleaks-reports/results.json ]; then
            cp gitleaks-reports/results.json previous-findings.json
          else
            echo '[]' > previous-findings.json
          fi
      
      - name: Upload Previous Findings
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: previous-findings
          path: previous-findings.json
          retention-days: 30
      
      - name: Fail on Findings
        if: steps.extract-metadata.outputs.findings_count > 0
        run: |
          echo "❌ Secret scan failed: ${{ steps.extract-metadata.outputs.findings_count }} potential secrets found"
          echo "Please review and remove any exposed secrets before merging."
          exit 1
