{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://gitzen.dev/schemas/metadata-v1.json",
  "title": "GitZen Privacy-Safe Metadata Schema",
  "description": "Schema for privacy-safe secret scan metadata. This schema ensures no source code or actual secret values are transmitted.",
  "type": "object",
  "required": ["version", "scan_context", "findings"],
  "additionalProperties": false,
  "properties": {
    "version": {
      "type": "string",
      "description": "Schema version",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "const": "1.0.0"
    },
    "scan_context": {
      "type": "object",
      "description": "Context information about the scan",
      "required": ["repo_name", "repo_owner", "commit_hash", "scan_timestamp"],
      "additionalProperties": false,
      "properties": {
        "repo_name": {
          "type": "string",
          "description": "Full repository name (owner/repo)",
          "pattern": "^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$"
        },
        "repo_owner": {
          "type": "string",
          "description": "Repository owner/organization",
          "pattern": "^[a-zA-Z0-9_.-]+$"
        },
        "branch": {
          "type": "string",
          "description": "Git branch name"
        },
        "commit_hash": {
          "type": "string",
          "description": "Git commit SHA (full or short)",
          "pattern": "^[0-9a-f]{7,40}$"
        },
        "trigger_type": {
          "type": "string",
          "description": "GitHub event that triggered the scan",
          "enum": ["push", "pull_request", "schedule", "workflow_dispatch", "merge_group"]
        },
        "pr_number": {
          "type": ["integer", "null"],
          "description": "Pull request number (if applicable)",
          "minimum": 1
        },
        "scan_timestamp": {
          "type": "string",
          "description": "ISO 8601 timestamp of the scan",
          "format": "date-time"
        },
        "gitleaks_version": {
          "type": "string",
          "description": "Version of Gitleaks used for scanning",
          "pattern": "^v?\\d+\\.\\d+\\.\\d+$"
        },
        "action_version": {
          "type": "string",
          "description": "Version of the GitZen GitHub Action",
          "pattern": "^v?\\d+\\.\\d+\\.\\d+$"
        }
      }
    },
    "findings": {
      "type": "array",
      "description": "Array of privacy-safe finding metadata",
      "items": {
        "type": "object",
        "required": ["finding_id", "file_path", "line_number", "secret_type", "secret_hash", "severity"],
        "additionalProperties": false,
        "properties": {
          "finding_id": {
            "type": "string",
            "description": "Unique identifier for this finding (SHA-256 hash of file+line+rule)",
            "pattern": "^[0-9a-f]{64}$"
          },
          "file_path": {
            "type": "string",
            "description": "Relative file path within repository",
            "minLength": 1,
            "maxLength": 4096,
            "not": {
              "pattern": "^/|^\\.\\./|\\.\\./"
            }
          },
          "line_number": {
            "type": "integer",
            "description": "Line number where secret was found",
            "minimum": 1
          },
          "end_line": {
            "type": "integer",
            "description": "End line number (for multi-line secrets)",
            "minimum": 1
          },
          "column_start": {
            "type": "integer",
            "description": "Starting column position",
            "minimum": 1
          },
          "column_end": {
            "type": "integer",
            "description": "Ending column position",
            "minimum": 1
          },
          "commit_hash": {
            "type": "string",
            "description": "Commit where this secret was introduced",
            "pattern": "^[0-9a-f]{7,40}$"
          },
          "author_hash": {
            "type": "string",
            "description": "SHA-256 hash of author email (for privacy)",
            "pattern": "^[0-9a-f]{64}$"
          },
          "secret_type": {
            "type": "string",
            "description": "Type of secret detected (rule ID)",
            "minLength": 1,
            "maxLength": 200
          },
          "secret_hash": {
            "type": "string",
            "description": "SHA-256 hash of the secret value (NOT the secret itself)",
            "pattern": "^sha256:[0-9a-f]{64}$"
          },
          "entropy": {
            "type": "number",
            "description": "Entropy score of the detected secret",
            "minimum": 0,
            "maximum": 8
          },
          "severity": {
            "type": "string",
            "description": "Severity level of the finding",
            "enum": ["critical", "high", "medium", "low", "info"]
          },
          "tags": {
            "type": "array",
            "description": "Tags associated with the finding",
            "items": {
              "type": "string"
            }
          },
          "match_fingerprint": {
            "type": "string",
            "description": "Fingerprint of the match pattern (for deduplication)",
            "pattern": "^[0-9a-f]{64}$"
          }
        }
      }
    },
    "summary": {
      "type": "object",
      "description": "Summary statistics of the scan",
      "required": ["total_findings", "by_severity"],
      "properties": {
        "total_findings": {
          "type": "integer",
          "description": "Total number of findings",
          "minimum": 0
        },
        "by_severity": {
          "type": "object",
          "description": "Breakdown by severity level",
          "required": ["critical", "high", "medium", "low"],
          "properties": {
            "critical": {
              "type": "integer",
              "minimum": 0
            },
            "high": {
              "type": "integer",
              "minimum": 0
            },
            "medium": {
              "type": "integer",
              "minimum": 0
            },
            "low": {
              "type": "integer",
              "minimum": 0
            },
            "info": {
              "type": "integer",
              "minimum": 0
            }
          }
        },
        "by_type": {
          "type": "object",
          "description": "Breakdown by secret type",
          "additionalProperties": {
            "type": "integer",
            "minimum": 0
          }
        },
        "unique_files": {
          "type": "integer",
          "description": "Number of unique files with findings",
          "minimum": 0
        }
      }
    }
  },
  "definitions": {
    "privacy_constraints": {
      "description": "These fields MUST NEVER be included in the metadata",
      "prohibited_fields": [
        "code",
        "source_code",
        "line_content",
        "match",
        "secret_value",
        "secret",
        "matched_text",
        "context",
        "code_snippet",
        "file_content",
        "diff"
      ]
    }
  }
}
